<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Mic - Rekam Suara</title>
</head>
<body>
  <h2>🎤 Rekam Suara</h2>
  <button id="startBtn">Mulai Rekam</button>
  <button id="stopBtn" disabled>Stop & Upload</button>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- Koneksi Supabase -->
  <script src="supabaseClient.js"></script>

  <script>
    let mediaRecorder;
    let chunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);

        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        alert('❌ Tidak bisa akses mikrofon: ' + err.message);
      }
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;

      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const filename = `audio-${Date.now()}.webm`;

        try {
          // Upload ke Supabase Storage
          const { error: uploadError } = await supabase.storage.from('rekaman').upload(filename, blob);
          if (uploadError) {
            alert('❌ Upload gagal: ' + uploadError.message);
            return;
          }

          // Simpan log ke database
          const { error: insertError } = await supabase.from('log_suara').insert([{ filename }]);
          if (insertError) {
            alert('❌ Gagal menyimpan log: ' + insertError.message);
            return;
          }

          alert('✅ Suara berhasil dikirim!');
        } catch (err) {
          alert('❌ Error saat mengirim: ' + err.message);
          console.error(err);
        }
      };
    };
  </script>
</body>
</html>
